#!/usr/bin/python

import os
import time
import signal
import subprocess
import pwd

from itsdangerous import Signer

SECRET_KEY = '9b72982d6b9bda33cc9366cd4d4ebe359ecd779232cf58aecb9aec2f363b'

def makeuser(username, pw):
    try:
        print "\n\033[31mCreating user account...\033[0m"
        subprocess.check_output(['./mkuser.sh', username, pw])
    except subprocess.CalledProcessError:
        return False
    return True

def login():
    print "\033[32mWelcome to the \033[33mHack The Vote 2016 \033[32mSession system\033[0m"
    print "You are requesting a session for 'ballot return'"
    print
    print "Please enter your team password to continue (found in the challenge description):"
    print ">>",
    pw = raw_input()

    try:
        teamid = Signer(SECRET_KEY).unsign(pw)
    except Exception as e:
        print "\033[31mInvalid password!"
        exit()

    username = teamid.replace('/','')

    # Create user if not exist
    try:
        pwd.getpwnam(username)
        print "\033[32mUser already exists",
    except KeyError:
        if not makeuser(username, pw):
            print "Error creating user. ping @clarkb7"
            exit()
        print "\033[32mYou may now",
    print "\033[33m`ssh ballot{}@ballotreturn.pwn.democrat` \033[32mwith your secret to cast your vote\033[0m".format(username)
        
login()


