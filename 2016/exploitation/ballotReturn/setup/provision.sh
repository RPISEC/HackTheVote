CHALPATH="/ballot_return"

# Install stuff
sudo apt-get install python-dev libpython2.7 socat python-itsdangerous

# Enable pw auth for ssh for ctf group

# Disable stupid shit
chmod -R -x /etc/update-motd.d/
rm /etc/legal

# Make player group
groupadd ctf
# Make suid 'ctfadmin' user
useradd -G ctf -s /bin/false ctfadmin

# Make user for each registered team (Need on-the-fly updates if registration stays open)
# Need way to give each team their own password, too
#useradd -G ctf -d $CHALPATH -s $CHALPATH/ballot_return user
#passwd user
## Set nproc limit for the vuln
#echo -e "user\thard\tnproc\t16" >> /etc/security/limits.conf

# Make dir for chall files
chattr -Ri $CHALPATH
rm -rf $CHALPATH
mkdir $CHALPATH
chown root:ctf $CHALPATH
chmod 750 $CHALPATH

# Add challenge binary
cp ./ballot_return $CHALPATH/ballot_return
chown ctfadmin:ctf $CHALPATH/ballot_return
chmod 4750 $CHALPATH/ballot_return

# Add database
cp ./ballots.db $CHALPATH/ballots.db
chown ctfadmin:ctfadmin $CHALPATH/ballots.db
chmod 700 $CHALPATH/ballots.db

# Add flag
cp ./flag $CHALPATH/flag
chown ctfadmin:ctfadmin $CHALPATH/flag
chmod 700 $CHALPATH/flag

# Add dbg.sh
(echo '#!/bin/sh' \
; echo "python $CHALPATH/dbgsh.py") > $CHALPATH/dbg.sh
chown ctfadmin:ctf $CHALPATH/dbg.sh
chmod 750 $CHALPATH/dbg.sh
cp ./dbgsh.py $CHALPATH/dbgsh.py
chown ctfadmin:ctf $CHALPATH/dbgsh.py
chmod 750 $CHALPATH/dbgsh.py

# Add dbgcat
cp ./dbgcat.sh $CHALPATH/dbgcat.sh
chown ctfadmin:ctf $CHALPATH/dbgcat.sh
chmod 750 $CHALPATH/dbgcat.sh

# chattr the whole damn dir
chattr -R +i $CHALPATH

